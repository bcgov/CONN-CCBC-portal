## Relay testing helpers

### Features

the `PageTestingHelper` and `ComponentTestingHelper` classes provide the following:

- `loadQuery(optional_resolver_override)` - preloads the Relay query for rendering
- `renderPage()` renders the page with the react testing library - accessible through `screen`
- `environment` the test relay environment to assert or configure the query generator
- `errorContext` a mock error context that can be used to check for errors being displayed

### Page Testing Helper Example

```typescript

// Import the page and the Query objects generated by Relay
import { ProjectViewPage } from "pages/cif/project/[project]/index";
import compiledProjectOverviewQuery, {
  ProjectOverviewQuery,
} from "__generated__/ProjectOverviewQuery.graphql";

// Resolver must match the response from the query inside the page
const defaultMockResolver = {
  Project() {
    return {
      rowId: 1,
      projectName: "Test Project",
      ...
    }
  }
}

const pageTestingHelper = new PageTestingHelper<ProjectOverviewQuery>({
  pageComponent: ProjectViewPage,
  compiledQuery: compiledProjectOverviewQuery,
  defaultQueryResolver: defaultMockResolver,
  defaultQueryVariables: { project: "mock-project-id" },
});

describe("my suite of tests", () => {
  beforeEach(() => {
    // reinit the helper before each test
    pageTestingHelper.reinit();
  });

  it("renders the page", () => {
    pageTestingHelper.loadQuery(); // or pageTestingHelper.loadQuery(differentResolver) if you need different resolvers for different tests
    pageTestingHelper.renderPage();

    expect(screen.getByText("Test Project")).toBeInTheDocument();
    expect(pageTestingHelper.environment.mock. ... ).toHaveBeenCalled();
    expect(pageTestingHelper.errorContext.setError).toHaveBeenCalledTimes(1);
    ...more tests...
  });

});

```

### Component Testing Helper Example

```typescript
import ProjectContactForm from "components/Form/ProjectContactForm";
import compiledProjectContactFormQuery, {
  ProjectContactFormQuery,
} from "__generated__/ProjectContactFormQuery.graphql";

// The query mimics a page that contains that component,
// we craft a test query that uses the fragments of the component we're testing.
const testQuery = graphql`
  query ProjectContactFormQuery @relay_test_operation {
    query {
      # Spread the fragment you want to test here
      ...ProjectContactForm_query
      projectRevision(id: "Test Project Revision ID") {
        ...ProjectContactForm_projectRevision
      }
    }
  }
`;

// This needs to match what we queried in our test query
const mockQueryPayload = {
  ProjectRevision() {
    const result: ProjectContactForm_projectRevision = {
      " $fragmentType": "ProjectContactForm_projectRevision",
      id: "Test Project Revision ID",
      rowId: 1234,
      ... etc ...
    };
    return result;
  },
  Query() {
    ...
  }
}

const defaultComponentProps = {
  setValidatingForm: jest.fn(),
  onSubmit: jest.fn(),
  ... etc ...
};

const componentTestingHelper =
  new ComponentTestingHelper<ProjectContactFormQuery>({
    component: ProjectContactForm,
    testQuery: testQuery,
    compiledQuery: compiledProjectContactFormQuery,
    getPropsFromTestQuery: (data) => ({
      // This is how to build the props for the component we're testing, based on our test query
      query: data.query,
      projectRevision: data.query.projectRevision,
    }),
    defaultQueryResolver: mockQueryPayload,
    defaultQueryVariables: {},
    // Additional default props for the component
    defaultComponentProps: defaultComponentProps,
  });

describe("the test suite", () => {
  beforeEach(() => {
    // reinit the helper before each test
    componentTestingHelper.reinit();
  });
  it(...){
    componentTestingHelper.loadQuery()
    componentTestingHelper.renderComponent() // or if you need extra props for a particular test: componentTestingHelper.renderComponent(undefined, {...defaultComponentProps, extraProps })

    ... same testing as with the page helper ...
  }
})

```
