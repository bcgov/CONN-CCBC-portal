name: Assign Jira Reviewer Based on PR Approval

on:
  pull_request_review:
    types: [submitted]

jobs:
  assign-reviewer:
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract Jira issue key and reviewer
        id: extract
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH"
          ISSUE_KEY=$(echo "$BRANCH" | grep -oE 'NDT-[0-9]+')
          echo "Extracted issue key: $ISSUE_KEY"

          REVIEWER_GITHUB="${{ github.event.review.user.login }}"
          echo "GitHub reviewer: $REVIEWER_GITHUB"

          JIRA_ID=$(jq -r --arg reviewer "$REVIEWER_GITHUB" '.[$reviewer]' .github/jira-reviewers.json)

          if [ "$JIRA_ID" == "null" ] || [ -z "$JIRA_ID" ]; then
            echo "No Jira ID found for GitHub user $REVIEWER_GITHUB"
            exit 1
          fi

          echo "Reviewer Jira ID: $JIRA_ID"
          echo "issue_key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          echo "jira_id=$JIRA_ID" >> $GITHUB_OUTPUT

      - name: Assign Jira reviewer
        run: |
          echo "Assigning Jira reviewer to ticket ${{ steps.extract.outputs.issue_key }}"
          curl -X PUT \
            --url "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ steps.extract.outputs.issue_key }}/assignee" \
            -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
            -H 'Content-Type: application/json' \
            --data "{\"accountId\": \"${{ steps.extract.outputs.jira_id }}\"}"
